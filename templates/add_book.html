<!DOCTYPE html>
<html>
<head>
    <title>Lend a Book | BookBee</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #FFF8E7, #FFE08A); }
        .navbar { background-color: #FFC83D; padding: 15px 40px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        .navbar h1 { margin: 0; color: #4A2C1A; }
        .form-container { max-width: 500px; margin: 40px auto; background: white; padding: 30px 35px; border-radius: 20px; box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08); }
        .form-container h2 { text-align: center; margin-bottom: 25px; color: #4A2C1A; }
        label { font-weight: 600; color: #5a4634; display: block; margin-bottom: 6px; }
        input, select, textarea { width: 100%; padding: 10px 12px; margin-bottom: 18px; border-radius: 10px; border: 1px solid #ddd; font-size: 14px; box-sizing: border-box; }
        .location-wrapper { position: relative; display: flex; gap: 10px; align-items: flex-start; }
        .detect-btn { width: auto; padding: 10px 15px; background: #2E7D32; color: white; font-size: 12px; margin-top: 0; height: 42px; }
        .detect-btn:hover { background: #1B5E20; }
        button[type="submit"] { width: 100%; padding: 12px; background-color: #FFC83D; border: none; border-radius: 25px; font-size: 16px; font-weight: 600; color: #4A2C1A; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button[type="submit"]:hover { background-color: #ffb700; }
        .error-list { color: red; font-size: 0.9rem; margin-bottom: 15px; list-style: none; padding: 0; }
    </style>
</head>
<body>

    <div class="navbar">
        <h1>üêù BookBee</h1>
    </div>

    <div class="form-container">
        <h2>üìö Lend Your Book</h2>

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            {% if form.errors %}
                <ul class="error-list">
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}

            <label>Title:</label>
            {{ form.title }}

            
            <label>Author:</label>
            {{ form.author }}

            <label>Book Cover:</label>
            {{ form.image }}

            <label>Description:</label>
            {{ form.description }}

            <label>Genre:</label>
            {{ form.genre }}

            <label>Price:</label>
            {{ form.price }}

            <label>Transaction Type:</label>
            {{ form.transaction_type }}

            <label>Security Amount:</label>
            {{ form.security_amount }}

            <label>Location:</label>
            <div class="location-wrapper">
                {{ form.location }}
                <button type="button" class="detect-btn" onclick="detectLocation()">üìç Detect</button>
            </div>

            <button type="submit">Add Book</button>
        </form>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const transactionField = document.getElementById('id_transaction_type');
        const securityField = document.getElementById('id_security_amount');
        const detectBtn = document.querySelector('.detect-btn'); // Select the button

        function toggleSecurity() {
            if (transactionField && securityField) {
                if (transactionField.value === 'buy') {
                    securityField.value = '0';
                    securityField.disabled = true;
                    securityField.style.backgroundColor = '#f3f3f3';
                } else {
                    securityField.disabled = false;
                    securityField.style.backgroundColor = 'white';
                }
            }
        }

        if (transactionField) {
            toggleSecurity();
            transactionField.addEventListener('change', toggleSecurity);
        }

        // Attach event listener explicitly to avoid inline onclick issues
        if(detectBtn) {
            detectBtn.addEventListener('click', detectLocation);
        }
    });

    function detectLocation() {
        const locationField = document.getElementById('id_location');
        if (!locationField) return;

        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser.");
            return;
        }

        locationField.placeholder = "üìç Locating...";
        
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                // SUCCESS: Coordinates found, now fetching address
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                
                // Using BigDataCloud API (Free, no key, more reliable for simple city names than OSM sometimes)
                fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`)
                .then(response => response.json())
                .then(data => {
                    // Extract just the main city/locality
                    const city = data.locality || data.city || data.principalSubdivision;
                    locationField.value = city; 
                })
                .catch(err => {
                    console.error("API Error:", err);
                    locationField.placeholder = "Error fetching address";
                    alert("Found coordinates, but could not get city name. Check internet connection.");
                });
            },
            (err) => {
                // ERROR: Browser blocked location or insecure connection
                console.error("Geolocation Error:", err);
                let msg = "Error.";
                if (err.code === 1) msg = "Permission denied. Please allow location access.";
                if (err.code === 2) msg = "Position unavailable. GPS signal lost.";
                if (err.code === 3) msg = "Timeout.";
                
                locationField.placeholder = "Type manually";
                alert(msg);
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    }
</script>
</body>
</html>