<!DOCTYPE html>
<html>

<head>
    <title>Lend a Book | BookBee</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #FFF8E7, #FFE08A);
        }

        .navbar {
            background-color: #FFC83D;
            padding: 15px 40px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar h1 {
            margin: 0;
            color: #4A2C1A;
        }

        .form-container {
            max-width: 500px;
            margin: 40px auto;
            background: white;
            padding: 30px 35px;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08);
        }

        .form-container h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #4A2C1A;
        }

        label {
            font-weight: 600;
            color: #5a4634;
            display: block;
            margin-bottom: 6px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 18px;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 14px;
            box-sizing: border-box;
        }

        /* Location Wrapper for the Button */
        .location-wrapper {
            position: relative;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .detect-btn {
            width: auto;
            padding: 10px 15px;
            background: #2E7D32;
            color: white;
            font-size: 12px;
            margin-top: 0;
            height: 42px;
        }

        .detect-btn:hover {
            background: #1B5E20;
        }

        button[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: #FFC83D;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            color: #4A2C1A;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }

        button[type="submit"]:hover {
            background-color: #ffb700;
        }
    </style>
</head>

<body>

    <div class="navbar">
        <h1>üêù BookBee</h1>
    </div>

    <div class="form-container">
        <h2>üìö Lend Your Book</h2>

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div style="color: red; margin-bottom: 10px;">
                {{ form.non_field_errors }}
            </div>

            <label>Title:</label>
            {{ form.title }}

            <label>Book Cover:</label>
            {{ form.image }}

            <label>Description:</label>
            {{ form.description }}

            <label>Genre:</label>
            {{ form.genre }}

            <label>Price:</label>
            {{ form.price }}

            <label>Transaction Type:</label>
            {{ form.transaction_type }}

            <label>Security Amount:</label>
            {{ form.security_amount }}

            <label>Location:</label>
            <div class="location-wrapper">
                {{ form.location }}
                <button type="button" class="detect-btn" onclick="detectLocation()">üìç Detect</button>
            </div>

            <button type="submit">Add Book</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 1. Handle Security Amount Logic
            const transactionField = document.getElementById('id_transaction_type');
            const securityField = document.getElementById('id_security_amount');

            function toggleSecurity() {
                if (transactionField.value === 'buy') {
                    securityField.value = '0'; // Set to 0 for sale
                    securityField.disabled = true;
                    securityField.style.backgroundColor = '#f3f3f3';
                    securityField.style.cursor = 'not-allowed';
                } else {
                    securityField.disabled = false;
                    securityField.style.backgroundColor = 'white';
                    securityField.style.cursor = 'text';
                }
            }

            if (transactionField && securityField) {
                toggleSecurity();
                transactionField.addEventListener('change', toggleSecurity);
            }

            // 2. Trigger Auto-Detection on Load
            detectLocation();
        });

        // 3. Robust Geolocation Function
        function detectLocation() {
            const locationField = document.getElementById('id_location');
            if (!locationField) return;

            if (!navigator.geolocation) {
                locationField.placeholder = "Geolocation not supported by your browser";
                return;
            }

            locationField.placeholder = "üìç Locating you...";

            navigator.geolocation.getCurrentPosition(
                // Success
                function (position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // Fetch address from OpenStreetMap (Nominatim)
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.display_name) {
                                // Shorten address for better UX (e.g., "Delhi, India")
                                let address = data.address;
                                let city = address.city || address.town || address.village || address.county;
                                let state = address.state;
                                let fullAddr = data.display_name;

                                // Prefer simple "City, State" if available, else full address
                                if (city && state) {
                                    locationField.value = `${city}, ${state}`;
                                } else {
                                    locationField.value = fullAddr;
                                }
                            } else {
                                locationField.value = `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
                            }
                        })
                        .catch(() => {
                            locationField.value = `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
                        });
                },
                // Error
                function (error) {
                    console.error("Geo Error:", error);
                    locationField.placeholder = "‚ö†Ô∏è Location permission denied. Please type manually.";
                }
            );
        }
    </script>

</body>

</html>